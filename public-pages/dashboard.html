<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predictr ‚Äî User Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script>
    tailwind = {
      config: {
        theme: {
          extend: {
            colors: {
              'brand-blue': '#387ef5',
              'brand-navy': '#242d3a',
              'brand-light': '#f8fafd',
              'success': '#00c851',
              'warning': '#ff9f43',
              'danger': '#ee5a52',
              'muted': '#9eb3c2'
            }
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .fade-up { opacity: 0; transform: translateY(12px); animation: fadeUp .5s ease-out forwards; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    .card-hover { transition: all .25s cubic-bezier(.4,0,.2,1); }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(36,45,58,.08); }
    .gradient-text { background: linear-gradient(45deg,#387ef5,#00c851); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  </style>
</head>
<body class="bg-white text-brand-navy antialiased" data-userid="{{ user_id }}">

  <!-- Top Nav -->
  <nav class="fixed top-0 inset-x-0 bg-white/95  border-gray-100 backdrop-blur z-50">
    <div class="max-w-7xl mx-auto px-4">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-brand-blue rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
          </div>
          <!--Add Company Logo-->
          <img src="{{ url_for('static', filename='assets/logo_file/svg/color-logo.svg') }}" class="w-30 h-30 rounded-lg" alt="Company Logo"/>
          <!-- <span class="text-lg font-semibold">Predictr Dashboard</span> -->
        </div>
        <div class="flex items-center gap-3">
          <div class="hidden sm:flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5">
            <span class="text-xs text-gray-500">Currency</span>
            <select id="currencySelect" class="bg-transparent text-sm outline-none">
              <option value="INR">INR ‚Çπ</option>
              <option value="USD">USD $</option>
              <option value="EUR">EUR ‚Ç¨</option>
              <option value="GBP">GBP ¬£</option>
            </select>
          </div>
          <!--Theme Toggle-->
          <!-- <button id="themeToggle" class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm hover:bg-gray-50">Light</button> -->
          <div class="flex items-center gap-2">
          <img src="{{ url_for('static', filename='assets/elements/user.png') }}" class="w-8 h-8 rounded-full" alt="avatar"/>
         <span class="hidden sm:block text-sm font-medium">Hi, {{ user_name }}</span>
         </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="pt-20 max-w-7xl mx-auto px-4 grid grid-cols-12 gap-6">
    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-3 lg:col-span-2">
      <div class="bg-brand-light border border-gray-100 rounded-2xl p-3 md:p-4 sticky top-24">
        <a data-nav="overview" class="nav-item block px-4 py-2.5 rounded-xl font-medium hover:bg-white hover:shadow card-hover bg-white shadow">Overview</a>
        <a data-nav="mystocks" class="nav-item block px-4 py-2.5 rounded-xl font-medium hover:bg-white hover:shadow card-hover mt-2">My Stocks</a>
        <a data-nav="transactions" class="nav-item block px-4 py-2.5 rounded-xl font-medium hover:bg-white hover:shadow card-hover mt-2">Transactions</a>
        <a data-nav="settings" class="nav-item block px-4 py-2.5 rounded-xl font-medium hover:bg-white hover:shadow card-hover mt-2">Settings</a>
        
        <!-- Exchange Rates Box -->
        <div class="mt-6 p-3 bg-white rounded-xl shadow-sm">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">
            Live Exchange Rates
            <span id="rate-status-indicator" class="inline-block w-2 h-2 bg-yellow-400 rounded-full ml-2" title="Loading rates..."></span>
          </h3>
          <div class="text-xs text-gray-600 space-y-1">
            <div class="flex justify-between">
              <span>1 USD =</span>
              <span id="rate-usd" class="font-mono">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span>1 EUR =</span>
              <span id="rate-eur" class="font-mono">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span>1 GBP =</span>
              <span id="rate-gbp" class="font-mono">Loading...</span>
            </div>
          </div>
          <div class="mt-3 pt-2 border-t border-gray-100">
            <p class="text-xs text-gray-500">
              <span class="font-medium">Base:</span> 1 INR to other currencies<br>
              <span class="font-medium">Source:</span> ExchangeRate-API<br>
              <span class="font-medium">Updated:</span> <span id="rate-timestamp">Loading...</span>
            </p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-6 pb-16">
      <!-- Overview -->
  <section id="section-overview">
        <div class="flex items-center justify-between">
          <h1 class="text-2xl md:text-3xl font-bold">Portfolio Overview</h1>
          <div class="text-sm text-gray-500">Live data from APIs & Database</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mt-4">
          <!-- Cards -->
          <div class="bg-white border border-gray-100 rounded-2xl p-5 card-hover">
            <div class="text-sm text-gray-500">Total Invested</div>
            <div id="kpi-invested" class="text-2xl font-semibold mt-1">‚Çπ0</div>
          </div>
          <div class="bg-white border border-gray-100 rounded-2xl p-5 card-hover">
            <div class="text-sm text-gray-500">Current Value</div>
            <div id="kpi-current" class="text-2xl font-semibold mt-1">‚Çπ0</div>
          </div>
          <div class="bg-white border border-gray-100 rounded-2xl p-5 card-hover">
            <div class="text-sm text-gray-500">P/L (Abs)</div>
            <div id="kpi-pl" class="text-2xl font-semibold mt-1">‚Çπ0</div>
          </div>
          <div class="bg-white border border-gray-100 rounded-2xl p-5 card-hover">
            <div class="text-sm text-gray-500">P/L (%)</div>
            <div id="kpi-plp" class="text-2xl font-semibold mt-1">0%</div>
          </div>
        </div>

        <!-- Mini chart (static SVG sparkline based on data) -->
        <!-- <div class="bg-white border border-gray-100 rounded-2xl p-5 mt-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Portfolio Sparkline</div>
            <div class="text-xs text-gray-500">Last 7 points</div>
          </div>
          <svg id="sparkline" viewBox="0 0 300 60" class="w-full h-16">
            <defs>
              <linearGradient id="sparkGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#387ef5" stop-opacity="0.25" />
                <stop offset="100%" stop-color="#387ef5" stop-opacity="0.05" />
              </linearGradient>
            </defs>
            <path id="sparkPath" d="" stroke="#387ef5" stroke-width="2.5" fill="none" />
            <path id="sparkFill" d="" fill="url(#sparkGrad)" />
          </svg>
        </div> -->

        <!-- Search Bar for Stocks -->
<div class="relative bg-white border border-gray-100 rounded-2xl p-5 mt-6 flex items-center gap-3">
  <input id="stockSearchInput" type="text" class="border border-gray-200 rounded-lg px-4 py-2 w-full" placeholder="Search your stocks by symbol or name..." />
  <button id="stockSearchBtn" class="bg-white text-black px-6 py-2 rounded-lg transition-colors font-medium border hover:bg-[#b2e0d4]">Search</button>
</div>

<div class="grid grid-cols-1 md:grid-cols-5 gap-6 mt-6">

  <div class="col-span-2 bg-white border border-gray-100 rounded-2xl p-5 flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Stock Prediction Graph</div>
      <div class="flex items-center gap-2">
        <label for="predictionRange" class="text-xs text-gray-500">Range:</label>
        <select id="predictionRange" class="border border-gray-200 rounded-lg px-2 py-1 text-xs">
          <option value="7">7 Days</option>
          <option value="30">1 Month</option>
          <option value="90">3 Months</option>
          <option value="365">1 Year</option>
        </select>
      </div>
    </div>
    <div class="flex-1 flex items-center justify-center">
      <canvas id="predictionGraph" class="w-full h-48"></canvas>
    </div>
    <div class="mt-2 text-xs text-gray-500">Scroll or select range to view predictions for next n days/months/years.</div>
  </div>

  <div class="col-span-3 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-4">
    <div class="bg-white border border-gray-100 rounded-2xl p-5 flex flex-col justify-center">
      <div class="text-sm text-gray-500">Amount Invested</div>
      <div id="info-invested" class="text-xl font-semibold mt-1">50,000</div>
    </div>
    <div class="bg-white border border-gray-100 rounded-2xl p-5 flex flex-col justify-center">
      <div class="text-sm text-gray-500">Predicted Value</div>
      <div id="info-predicted" class="text-xl font-semibold mt-1">52,500</div>
    </div>
    <div class="bg-white border border-gray-100 rounded-2xl p-5 flex flex-col justify-center">
      <div class="text-sm text-gray-500">Prediction Accuracy</div>
      <div id="info-accuracy" class="text-xl font-semibold mt-1">95%</div>
    </div>
    <div class="bg-white border border-gray-100 rounded-2xl p-5 flex flex-col justify-center">
      <div class="text-sm text-gray-500">Other Details</div>
      <div id="info-other" class="text-xl font-semibold mt-1">All positions stable</div>
    </div>
  </div>

  <div id="search-actions" class="col-span-3 md:col-span-5 mt-4">
      <button id="prepareAddStockBtn" class="bg-brand-blue text-white font-medium px-6 py-3 rounded-lg w-full card-hover">
        Add This Stock to My Portfolio
      </button>
      <button id="saveStockBtn" class="bg-brand-blue text-white font-medium px-6 py-3 rounded-lg w-full card-hover">
      Quick Save
    </button>
  </div>
  
</div>
      </section>


      <!-- My Stocks -->
  <section id="section-mystocks" class="hidden">
        <div class="flex items-center justify-between">
          <h2 class="text-xl md:text-2xl font-bold">My Stocks</h2>
          <div class="flex items-center gap-2">
            <button id="openAddModal" class="bg-white text-black px-6 py-2 rounded-lg transition-colors font-medium border-b hover:bg-[#b2e0d4]">Add Stock</button>
            <button id="clearAllBtn" class="bg-white text-black px-6 py-2 rounded-lg transition-colors font-medium border-b hover:bg-[#b2e0d4]">Clear All</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto bg-white border border-gray-100 rounded-2xl">
          <table class="min-w-full text-sm">
            <thead class="bg-brand-light text-gray-600">
              <tr>
                <th class="text-left p-3">Symbol</th>
                <th class="text-left p-3">Company</th>
                <th class="text-right p-3">Qty</th>
                <th class="text-right p-3">Buy Price</th>
                <th class="text-right p-3">Current Price</th>
                <th class="text-right p-3">P/L</th>
                <th class="text-right p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="stocksTbody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div class="h-25"></div>
      </section>

      

      <!-- Transactions -->
  <section id="section-transactions" class="hidden">
        <div class="flex items-center justify-between">
          <h2 class="text-xl md:text-2xl font-bold">Transactions</h2>
          <div class="text-sm text-gray-500">Auto-generated from your buys/sells</div>
        </div>
        <div class="mt-4 overflow-x-auto bg-white border border-gray-100 rounded-2xl">
          <table class="min-w-full text-sm">
            <thead class="bg-brand-light text-gray-600">
              <tr>
                <th class="text-left p-3">Date</th>
                <th class="text-left p-3">Symbol</th>
                <th class="text-left p-3">Type</th>
                <th class="text-right p-3">Qty</th>
                <th class="text-right p-3">Price</th>
                <th class="text-right p-3">Total</th>
              </tr>
            </thead>
            <tbody id="txTbody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div class="h-50"></div>
      </section>

      <!-- Settings -->
  <section id="section-settings" class="hidden">
        <h2 class="text-xl md:text-2xl font-bold mb-4">Settings</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white border border-gray-100 rounded-2xl p-5">
            <div class="font-semibold mb-3">Currency</div>
            <p class="text-sm text-gray-600 mb-2">Choose the display currency for your portfolio.</p>
            <select id="currencySelect2" class="border border-gray-200 rounded-lg px-3 py-2 w-full">
              <option value="INR">INR ‚Çπ</option>
              <option value="USD">USD $</option>
              <option value="EUR">EUR ‚Ç¨</option>
              <option value="GBP">GBP ¬£</option>
            </select>
          </div>
          <!-- <div class="bg-white border border-gray-100 rounded-2xl p-5">
            <div class="font-semibold mb-3">Theme</div>
            <p class="text-sm text-gray-600 mb-2">Light/Dark theme preference.</p>
            <button id="themeToggle2" class="px-4 py-2 border rounded-lg">Toggle Theme</button>
          </div> -->
        </div>
        <div class="h-25"></div>
      </section>
    </main>
  </div>
  

  <!-- Add/Edit Stock Modal -->
  <!--Stock Details to be fetched from Yahoo Finance API-->
   <div id="stockModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-[60]">
    <div class="bg-white w-full max-w-lg rounded-2xl p-6 border border-gray-100 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalTitle" class="text-lg font-semibold">Add Stock</h3>
        <button id="closeModal" class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center">‚úï</button>
      </div>
      <form id="stockForm" class="grid grid-cols-2 gap-4">
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Stock Symbol</label>
          <input id="fSymbol" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="AAPL" />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Company Name</label>
          <input id="fCompanyInput" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Apple Inc." />
        </div>
        <div class="col-span-2 flex items-center gap-2">
          <button type="button" id="lookupBtn" class="bg-white text-black px-6 py-2 rounded-lg transition-colors font-medium border hover:bg-[#b2e0d4]">Fetch Details</button>
          <span id="lookupStatus" class="text-sm text-success"></span>
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Company Name</label>
          <input id="fCompany" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 bg-brand-light text-gray-500" readonly />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Exchange</label>
          <input id="fExchange" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 bg-brand-light text-gray-500" readonly />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Currency</label>
          <input id="fCurrency" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 bg-brand-light text-gray-500" readonly />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Sector</label>
          <input id="fSector" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 bg-brand-light text-gray-500" readonly />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Quantity</label>
          <input id="fQty" type="number" min="1" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="10" required />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Buy Price</label>
          <input id="fBuy" type="number" min="0" step="0.01" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="175.50" required />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Current Price <span class="text-xs text-gray-500">(Auto-fetched)</span></label>
          <input id="fCurrent" type="number" min="0" step="0.01" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 bg-gray-50" placeholder="Loading..." readonly />
        </div>
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Date</label>
          <input id="fDate" type="date" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2" required />
        </div>
        <input type="hidden" id="editingIndex" value="" />
        <div class="col-span-2 flex items-center justify-end gap-3 mt-2">
          <button type="button" id="resetModal" class="px-4 py-2 border rounded-lg">Reset</button>
          <button type="button" id="cancelModal" class="px-4 py-2 border rounded-lg">Cancel</button>
          <button type="submit" class="bg-white text-black px-6 py-2 rounded-lg transition-colors font-medium border hover:bg-[#b2e0d4]">Save</button>
        </div>
      </form>
    </div>
  </div>
  <!--Push footer down-->
    <div class="h-40"></div>

  <footer class="mt-10 border-t border-gray-100 py-8 bg-brand-light">
    <div class="max-w-7xl mx-auto px-4 text-sm text-gray-600 flex flex-wrap items-center justify-between gap-4">
      <div>¬© <span id="year"></span> Predictr ‚Äî Dashboard</div>
      <div class="flex items-center gap-4">
        <a href="#" class="hover:text-brand-blue">Terms</a>
        <a href="#" class="hover:text-brand-blue">Privacy</a>
        <a href="#" class="hover:text-brand-blue">Support</a>
      </div>
    </div>
  </footer>

<script>
  // ===== Live currency rates (will be updated from API) =====
  let FX = { USD: 1, EUR: 0.92, GBP: 0.78, INR: 84 }; // Default fallback rates
  const DEFAULT_CCY = localStorage.getItem('predictr_ccy') || 'INR';

  // ===== State =====
  let state = JSON.parse(localStorage.getItem('predictr_state')||'null') || {
    currency: DEFAULT_CCY,
    stocks: [],
    transactions: []
  };

  // ===== Utilities =====
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  const fmt = (v) => {
    const cur = state.currency;
    const usd = v;
    const fxRate = FX[cur] || 1;
    const converted = usd * fxRate;
    const symbol = cur==='USD'?'$':cur==='EUR'?'‚Ç¨':cur==='GBP'?'¬£':'‚Çπ';
    // Using live exchange rates for conversion
    return symbol + converted.toLocaleString(undefined,{maximumFractionDigits:2});
  };
  
  // Format value in specific currency (for individual stocks)
  const fmtCurrency = (v, currency) => {
    const symbol = currency==='USD'?'$':currency==='EUR'?'‚Ç¨':currency==='GBP'?'¬£':'‚Çπ';
    return symbol + v.toLocaleString(undefined,{maximumFractionDigits:2});
  };
  
  // Convert amount from one currency to another using live exchange rates
  const convertCurrency = (amount, fromCurrency, toCurrency) => {
    if (fromCurrency === toCurrency) return amount;
    
    const fromRate = FX[fromCurrency] || 1;
    const toRate = FX[toCurrency] || 1;
    
    // Convert from source currency to USD first
    const amountInUSD = amount / fromRate;
    
    // Convert from USD to target currency
    const amountInTarget = amountInUSD * toRate;
    
    return amountInTarget;
  };
  const save = () => {
    localStorage.setItem('predictr_state', JSON.stringify(state));
    localStorage.setItem('predictr_ccy', state.currency);
  };

  // ===== Derived metrics =====
  function totals() {
  // Always calculate KPIs in user's default currency (INR) for consistency
  let invested = 0, current = 0;
  const baseCurrency = 'INR'; // User's default currency for portfolio calculations
  const displayCurrency = state.currency; // Currency selected in UI
  
  console.log(`üí∞ KPI Calculation - Base Currency: ${baseCurrency}, Display Currency: ${displayCurrency}`);
  
  state.stocks.forEach(s => {
    const stockCurrency = s.currency || 'USD';
    const qty = (+s.qty) || 0;
    const buyPrice = (+s.buy) || 0;
    const currentPrice = (+s.current) || 0;
    
    // Convert stock prices from their native currency to base currency (INR)
    const buyInINR = convertCurrency(buyPrice, stockCurrency, baseCurrency);
    const currentInINR = convertCurrency(currentPrice, stockCurrency, baseCurrency);
    
    const totalBuyInINR = buyInINR * qty;
    const totalCurrentInINR = currentInINR * qty;
    
    console.log(`üí∞ ${s.symbol}: ${buyPrice} ${stockCurrency} ‚Üí ${buyInINR.toFixed(2)} ${baseCurrency} √ó ${qty} = ${totalBuyInINR.toFixed(2)} ${baseCurrency} invested`);
    console.log(`üí∞ ${s.symbol}: ${currentPrice} ${stockCurrency} ‚Üí ${currentInINR.toFixed(2)} ${baseCurrency} √ó ${qty} = ${totalCurrentInINR.toFixed(2)} ${baseCurrency} current`);
    
    invested += totalBuyInINR;
    current += totalCurrentInINR;
  });
  
  const pl = current - invested;
  const plp = invested ? (pl / invested * 100) : 0;
  
  console.log(`üí∞ Portfolio Summary (${baseCurrency}): Invested=${invested.toFixed(2)}, Current=${current.toFixed(2)}, P/L=${pl.toFixed(2)}`);
  
  // If display currency is different from base currency, convert for display
  if (displayCurrency !== baseCurrency) {
    const investedDisplay = convertCurrency(invested, baseCurrency, displayCurrency);
    const currentDisplay = convertCurrency(current, baseCurrency, displayCurrency);
    const plDisplay = currentDisplay - investedDisplay;
    
    console.log(`üí∞ Display Conversion to ${displayCurrency}: Invested=${investedDisplay.toFixed(2)}, Current=${currentDisplay.toFixed(2)}, P/L=${plDisplay.toFixed(2)}`);
    
    return { 
      invested: investedDisplay, 
      current: currentDisplay, 
      pl: plDisplay, 
      plp: plp // Percentage remains the same
    };
  }
  
  return { invested, current, pl, plp };
}

  // ===== Refresh All Currency-Dependent Displays =====
  function refreshAllCurrencyDisplays() {
    console.log('üîÑ Refreshing all currency displays with updated rates');
    renderKPIs();
    renderStocks();
    // Update any other currency-dependent UI elements here
  }

  // ===== Rendering =====
  function renderKPIs(){
    const t = totals();
    const currencySymbol = state.currency==='USD'?'$':state.currency==='EUR'?'‚Ç¨':state.currency==='GBP'?'¬£':'‚Çπ';
    
    el('#kpi-invested').textContent = currencySymbol + t.invested.toLocaleString(undefined,{maximumFractionDigits:2});
    el('#kpi-current').textContent  = currencySymbol + t.current.toLocaleString(undefined,{maximumFractionDigits:2});
    el('#kpi-pl').textContent       = (t.pl >= 0 ? '+' : '-') + currencySymbol + Math.abs(t.pl).toLocaleString(undefined,{maximumFractionDigits:2});
    el('#kpi-pl').className = 'text-2xl font-semibold mt-1 ' + (t.pl>=0?'text-success':'text-danger');
    el('#kpi-plp').textContent = t.plp.toFixed(2) + '%';
    el('#kpi-plp').className = 'text-2xl font-semibold mt-1 ' + (t.plp>=0?'text-success':'text-danger');
    
    // Update or add currency calculation note
    const kpiGrid = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.xl\\:grid-cols-4.gap-4');
    let noteEl = document.getElementById('kpi-currency-note');
    
    if (!noteEl && kpiGrid) {
      noteEl = document.createElement('div');
      noteEl.id = 'kpi-currency-note';
      noteEl.className = 'col-span-full text-center text-xs text-gray-500 mt-2';
      kpiGrid.parentNode.insertBefore(noteEl, kpiGrid.nextSibling);
    }
    
    if (noteEl) {
      const baseCurrency = 'INR';
      const displayCurrency = state.currency;
      
      if (displayCurrency !== baseCurrency) {
        noteEl.textContent = `Portfolio calculated in user's default currency (${baseCurrency}), displayed in ${displayCurrency}`;
      } else {
        noteEl.textContent = `Portfolio calculated in user's default currency (${baseCurrency})`;
      }
    }
}
  function renderInfoBlocks(){
    // Use actual portfolio data instead of hardcoded values
    const t = totals();
    const baseCurrency = 'INR';
    
    // Convert totals to base currency (INR) for info blocks
    const investedInINR = state.currency !== baseCurrency ? 
      convertCurrency(t.invested, state.currency, baseCurrency) : t.invested;
    const currentInINR = state.currency !== baseCurrency ? 
      convertCurrency(t.current, state.currency, baseCurrency) : t.current;
    
    // Calculate predicted value (could be enhanced with ML model later)
    const predictedVal = currentInINR * 1.05; // Simple 5% growth prediction
    
    el('#info-invested').textContent = fmt(investedInINR);
    el('#info-predicted').textContent = fmt(predictedVal);
    el('#info-accuracy').textContent = 'Live Data';  // Updated to reflect real-time nature
    el('#info-other').textContent = state.stocks.length + ' active positions';
}


  function renderSparkline(){
    const sparkPath = el('#sparkPath');
    const sparkFill = el('#sparkFill');
    if (sparkPath && sparkFill) {
      sparkPath.setAttribute('d', '');
      sparkFill.setAttribute('d', '');
    }
  }

  function renderStocks(){
    const tbody = el('#stocksTbody');
    tbody.innerHTML = '';
    state.stocks.forEach((s,idx)=>{
      // Stock prices are in their native currency, convert to USD for consistent calculation
      const currency = s.currency || 'USD';
      const fxRate = FX[currency] || 1;
      
      // Convert stock prices from native currency to USD
      const buyNative = (+s.buy) || 0;
      const curNative = (+s.current) || 0;
      const qty = (+s.qty) || 0;
      
      // Convert to USD (stock prices are in native currency, divide by FX rate to get USD)
      const buyUSD = buyNative / fxRate;
      const curUSD = curNative / fxRate;
      
      // Calculate P/L in USD: (Current Price - Buy Price) √ó Quantity
      let plUSD = 0;
      if (buyNative > 0 && curNative > 0 && qty > 0) {
        plUSD = (curUSD - buyUSD) * qty;
      }
      
      console.log(`üìä P/L Calculation for ${s.symbol}: (${curUSD.toFixed(2)} - ${buyUSD.toFixed(2)}) √ó ${qty} = ${plUSD.toFixed(2)} USD`);
      console.log(`üîç Raw data for ${s.symbol}: buy=${buyNative} ${currency}, current=${curNative} ${currency}, qty=${qty}`);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-3 font-medium">${s.symbol}</td>
        <td class="p-3 text-gray-600">${s.company}</td>
        <td class="p-3 text-right">${s.qty}</td>
        <td class="p-3 text-right">${fmt(buyUSD)}</td>
        <td class="p-3 text-right">${fmt(curUSD)}</td>
        <td class="p-3 text-right ${plUSD>=0?'text-success':'text-danger'}">${plUSD>=0?'+':''}${fmt(Math.abs(plUSD))}</td>
        <td class="p-3 text-right">
          <button data-edit="${idx}" class="px-3 py-1.5 text-xs rounded-lg border mr-2 hover:bg-gray-50">Edit</button>
          <button data-del="${idx}" class="px-3 py-1.5 text-xs rounded-lg border hover:bg-gray-50">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function renderTx(){
    const tbody = el('#txTbody');
    tbody.innerHTML = '';
    state.transactions.forEach(tx=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-3">${tx.date}</td>
        <td class="p-3">${tx.symbol}</td>
        <td class="p-3">${tx.type}</td>
        <td class="p-3 text-right">${tx.qty}</td>
        <td class="p-3 text-right">${fmt(tx.price)}</td>
        <td class="p-3 text-right">${fmt(tx.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderAll(){
     renderKPIs();
    renderInfoBlocks();   // new
    renderSparkline();
    renderStocks();
    renderTx();
    save();
  }

  // ===== Navigation =====
  function showSection(id){
    ['overview','mystocks','transactions','settings'].forEach(key=>{
      const sec = el('#section-'+key);
      if (!sec) return;
      if (key === id) {
        sec.classList.remove('hidden');
        sec.style.opacity = 1;
        sec.style.transform = 'none';
      } else {
        sec.classList.add('hidden');
      }
    });
    els('.nav-item').forEach(a=>{
      a.classList.toggle('bg-white', a.dataset.nav===id);
      a.classList.toggle('shadow', a.dataset.nav===id);
    });
  }
  els('.nav-item').forEach(a=> a.addEventListener('click', ()=> showSection(a.dataset.nav)));

  // ===== Modal =====
  const openModal = () => { el('#stockModal').classList.remove('hidden'); };
  const closeModal = () => { el('#stockModal').classList.add('hidden'); el('#stockForm').reset(); el('#editingIndex').value=''; el('#modalTitle').textContent='Add Stock'; };
  el('#resetModal').addEventListener('click', ()=> {
    el('#stockForm').reset();
    el('#editingIndex').value='';
    el('#modalTitle').textContent='Add Stock';
    el('#lookupStatus').textContent='';
  });

  el('#openAddModal').addEventListener('click', () => {
    console.log('üîç Opening Add Stock modal...');
    debugFormElements();
    openModal();
  });
  el('#closeModal').addEventListener('click', closeModal);
  el('#cancelModal').addEventListener('click', closeModal);
  

  el('#stocksTbody').addEventListener('click', (e)=>{
    const edit = e.target.closest('button[data-edit]');
    const del  = e.target.closest('button[data-del]');
    if (edit){
      const idx = +edit.dataset.edit;
      const s = state.stocks[idx];
      el('#modalTitle').textContent='Edit Stock';
      el('#fSymbol').value = s.symbol;
      el('#fCompany').value = s.company;
      el('#fQty').value = s.qty;
      el('#fBuy').value = s.buy;
      el('#fCurrent').value = s.current;
      el('#fDate').value = s.date;
      el('#editingIndex').value = idx;
      openModal();
    }
    if (del){
      const idx = +del.dataset.del;
      const s = state.stocks[idx];
      
      if (confirm(`Are you sure you want to delete ${s.symbol} (${s.company})?`)) {
        console.log('üóëÔ∏è Deleting stock:', s.symbol);
        deleteStockFromServer(s.symbol, idx);
      }
    }
  });

  el('#stockForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    
    console.log('üöÄ Form submission started - checking live values...');
    
    // Check live DOM values right now
    const symbolEl = el('#fSymbol');
    const liveSymbol = symbolEl ? symbolEl.value : 'ELEMENT_NOT_FOUND';
    console.log('üîç Live symbol check: element exists=' + !!symbolEl + ', value="' + liveSymbol + '"');
    
    // Get form values
    const sym = el('#fSymbol').value?.trim().toUpperCase() || '';
    const com = el('#fCompany').value?.trim() || '';
    const qty = +el('#fQty').value || 0;
    const buy = +el('#fBuy').value || 0;
    const cur = +el('#fCurrent').value || 0;
    const dat = el('#fDate').value || '';
    const idx = el('#editingIndex').value;

    console.log('üìù Form submit - First handler: sym="' + sym + '", com="' + com + '", qty=' + qty + ', buy=' + buy + ', cur=' + cur + ', dat="' + dat + '", idx="' + idx + '"');

    // Capture form data for the second handler (before any potential form reset)
    const currency = el('#fCurrency').value?.trim() || 'USD';
    const exchange = el('#fExchange').value?.trim() || '';
    const sector = el('#fSector').value?.trim() || '';
    
    formDataForServer = {
      symbol: sym,
      company: com,
      qty: qty,
      buyPrice: buy,
      currentPrice: cur,
      date: dat,
      currency: currency,
      exchange: exchange,
      sector: sector,
      editingIndex: idx  // Capture editing mode
    };
    console.log('üíæ Captured form data for server persistence:', formDataForServer);

    // Validate required fields
    if (!sym) {
      alert('Please enter a stock symbol.');
      el('#fSymbol').focus();
      return;
    }
    
    if (!qty || qty <= 0) {
      alert('Please enter a valid quantity.');
      el('#fQty').focus();
      return;
    }
    
    if (!buy || buy <= 0) {
      alert('Please enter a valid buy price.');
      el('#fBuy').focus();
      return;
    }
    
    // Current price is auto-fetched, so we'll allow 0 if API failed
    if (!cur || cur <= 0) {
      console.log('‚ö†Ô∏è Current price not available, will use 0 (auto-fetch may have failed)');
      // Don't block submission, just warn
    }

    if (idx!==""){
      const before = structuredClone(state.stocks[idx]);
      state.stocks[idx] = { symbol:sym, company:com, qty, buy, current:cur, date:dat };
      state.transactions.push({ date:new Date().toISOString().slice(0,10), symbol:sym, type:'EDIT', qty: qty-before.qty, price: buy, total: (qty*buy) });
    } else {
      state.stocks.push({ symbol:sym, company:com, qty, buy, current:cur, date:dat });
      state.transactions.push({ date:dat, symbol:sym, type:'BUY', qty, price: buy, total: qty*buy });
    }
    closeModal();
    renderAll();
    showSection('mystocks');
  });

  // Global variable to store form data between handlers
  let formDataForServer = null;

  // Send saved stock to backend so it persists in MongoDB
  el('#stockForm').addEventListener('submit', async (e) => {
    // This second listener runs after the first (above) to persist the record.
    // Use the captured form data instead of reading from DOM (which might be reset)
    try {
      console.log('üîÑ Second handler starting - using captured data from first handler');
      
      // Use captured data if available, otherwise try to read from DOM
      const userId = document.body.dataset.userid || document.body.getAttribute('data-userid');
      let symbol, company, qty, buyPrice, currentPrice, date;
      
      if (formDataForServer) {
        console.log('‚úÖ Using captured form data from first handler');
        symbol = formDataForServer.symbol;
        company = formDataForServer.company;
        qty = formDataForServer.qty;
        buyPrice = formDataForServer.buyPrice;
        currentPrice = formDataForServer.currentPrice;
        date = formDataForServer.date;
      } else {
        console.log('‚ö†Ô∏è No captured data, reading from DOM (might be empty if form was reset)');
        symbol = el('#fSymbol').value?.trim().toUpperCase() || '';
        company = el('#fCompany').value?.trim() || '';
        qty = el('#fQty').value || '';
        buyPrice = el('#fBuy').value || '';
        currentPrice = el('#fCurrent').value || '';
        date = el('#fDate').value || '';
      }
      
      console.log('üîç Debug info - All form fields:');
      console.log('  userId: "' + userId + '"');
      console.log('  symbol: "' + symbol + '"');
      console.log('  company: "' + company + '"');
      console.log('  qty: "' + qty + '"');
      console.log('  buyPrice: "' + buyPrice + '"');
      console.log('  currentPrice: "' + currentPrice + '"');
      console.log('  date: "' + date + '"');
      console.log('  fSymbolElement exists: ' + !!el('#fSymbol'));
      console.log('  fSymbolValue direct: "' + (el('#fSymbol')?.value || '') + '"');
      
      if (!userId) {
        console.error('‚ùå No user_id found in data-userid attribute');
        alert('Error: User session not found. Please refresh the page and try again.');
        return;
      }
      
      if (!symbol) {
        console.error('‚ùå No symbol provided - form validation failed');
        alert('Error: Please enter a stock symbol before saving.');
        // Focus on the symbol input to help user
        const symbolInput = el('#fSymbol');
        if (symbolInput) {
          symbolInput.focus();
          symbolInput.style.borderColor = 'red';
          setTimeout(() => symbolInput.style.borderColor = '', 3000);
        }
        return;
      }

      // Validate required fields
      if (!qty || !buyPrice || !currentPrice) {
        console.error('‚ùå Missing required fields');
        alert('Error: Please fill in Quantity, Buy Price, and Current Price.');
        return;
      }

      const payload = {
        user_id: userId,
        symbol: symbol,
        longName: company,  // Use captured data
        exchange: formDataForServer?.exchange || undefined,  // Use captured data
        currency: formDataForServer?.currency || 'USD',  // Use captured data
        sector: formDataForServer?.sector || undefined,  // Use captured data
        qty: +qty || 0,  // Use captured data
        buy: +buyPrice || 0,  // Use captured data
        current: +currentPrice || 0,  // Use captured data
        date: date || new Date().toISOString().slice(0,10)  // Use captured data
      };

      console.log('üì§ Sending payload:', payload);
      
      // Determine if this is an edit or add operation
      const isEdit = formDataForServer?.editingIndex !== undefined && formDataForServer?.editingIndex !== "";
      const apiEndpoint = isEdit ? '/api/stocks/update_stock' : '/api/stocks/add_stock';
      
      console.log(isEdit ? 'üìù Updating existing stock' : '‚ûï Adding new stock');

      const res = await fetch(apiEndpoint, {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      console.log('üì• Server response:', { status: res.status, data });
      
      if (res.ok) {
        console.log('‚úÖ Saved to server:', data);
        alert('‚úÖ Stock saved successfully!');
        // Clear captured data after successful save
        formDataForServer = null;
        console.log('üßπ Cleared captured form data after successful save');
        // Reload from server to ensure canonical data
        loadMyStocks();
      } else {
        console.warn('‚ùå Server save failed', data);
        alert('‚ùå Error saving stock: ' + (data.error || 'Unknown error'));
        // Keep captured data for potential retry
      }
    } catch (err) {
      console.error('‚ùå Could not save stock to server', err);
      alert('‚ùå Network error. Please check your connection and try again.');
    }
  });

  el('#clearAllBtn').addEventListener('click', ()=>{
    if (confirm('Clear all stocks?')){
      state.transactions.push({ date:new Date().toISOString().slice(0,10), symbol:'*', type:'CLEAR', qty:0, price:0, total:0 });
      state.stocks = [];
      renderAll();
    }
  });

  // Real-time price updates now come from live API calls

  // ===== Currency handling =====
  function setCurrency(ccy){
    console.log(`üí± Currency changed to ${ccy}, using live rates:`, FX);
    state.currency = ccy;
    save();
    renderAll();  // now all values will be updated automatically with live rates
}

['#currencySelect','#currencySelect2'].forEach(id=>{
    const sel = el(id); 
    if(!sel) return; 
    sel.value = state.currency; 
    sel.addEventListener('change', ()=> setCurrency(sel.value));
});

  

  // All stock data now comes from live API calls - no more mock data

  el('#lookupBtn').addEventListener('click', function() {
    let symbol = el('#fSymbol').value.trim().toUpperCase();
    let company = el('#fCompanyInput').value.trim();
    if (symbol) {
      // Direct symbol lookup
      fetch(`/api/fetch_stock_details?symbol=${encodeURIComponent(symbol)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            el('#fCompany').value = '';
            el('#fExchange').value = '';
            el('#fCurrency').value = '';
            el('#fSector').value = '';
            el('#fCurrent').value = '';
            el('#lookupStatus').textContent = 'Not found.';
            el('#lookupStatus').className = 'text-sm text-danger';
          } else {
            el('#fCompany').value = data.longName || '';
            el('#fExchange').value = data.exchange || '';
            el('#fCurrency').value = data.currency || '';
            el('#fSector').value = data.sector || '';
            el('#lookupStatus').textContent = 'Details fetched!';
            el('#lookupStatus').className = 'text-sm text-success';
          }
        })
        .catch(() => {
          el('#fCompany').value = '';
          el('#fExchange').value = '';
          el('#fCurrency').value = '';
          el('#fSector').value = '';
          el('#fCurrent').value = '';
          el('#lookupStatus').textContent = 'Error fetching.';
          el('#lookupStatus').className = 'text-sm text-danger';
        });
    } else if (company) {
      // Search by company name
      el('#lookupStatus').textContent = 'Searching...';
      el('#lookupStatus').className = 'text-sm text-brand-blue';
      fetch(`/api/search_company?company=${encodeURIComponent(company)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error || !data.results.length) {
            el('#lookupStatus').textContent = 'No matches found.';
            el('#lookupStatus').className = 'text-sm text-danger';
            el('#symbolDropdown')?.remove();
          } else {
            // Create dropdown for user to select symbol
            let dropdown = document.getElementById('symbolDropdown');
            if (dropdown) dropdown.remove();
            // Create label for dropdown
            const label = document.createElement('label');
            label.textContent = 'Select Symbol from available options:';
            label.className = 'text-sm text-gray-600 mt-2';
            // Create dropdown
            dropdown = document.createElement('select');
            dropdown.id = 'symbolDropdown';
            dropdown.className = 'mt-1 w-full border border-gray-200 rounded-lg px-3 py-2';
            data.results.forEach(item => {
              const option = document.createElement('option');
              option.value = item.symbol;
              // Format: Symbol | Name | Exchange | Currency
              option.textContent = `${item.symbol} | ${item.shortname || ''} | ${item.exchange || ''}`;
              // option.textContent = `${item.symbol} | ${item.shortname || ''} | ${item.exchange || ''} | ${item.currency || ''}`;
              dropdown.appendChild(option);
            });
            // Insert label and dropdown after fSymbol input
            const parent = el('#fSymbol').parentNode;
            parent.appendChild(label);
            parent.appendChild(dropdown);
            el('#lookupStatus').textContent = 'Select a symbol.';
            el('#lookupStatus').className = 'text-sm text-success';
            dropdown.onchange = function() {
              el('#fSymbol').value = this.value;
              // Auto-fetch details for selected symbol
              el('#lookupBtn').click();
              label.remove();
              dropdown.remove();
            };
          }
        })
        .catch(() => {
          el('#lookupStatus').textContent = 'Error searching.';
          el('#lookupStatus').className = 'text-sm text-danger';
          el('#symbolDropdown')?.remove();
        });
    } else {
      el('#lookupStatus').textContent = 'Enter symbol or company name.';
      el('#lookupStatus').className = 'text-sm text-danger';
    }
  });

  // ===== Debug Function =====
  function debugFormElements() {
    console.log('üîß Form Elements Debug:');
    const elements = ['#fSymbol', '#fCompany', '#fQty', '#fBuy', '#fCurrent', '#fDate'];
    elements.forEach(selector => {
      const element = el(selector);
      console.log(`   ${selector}: exists=${!!element}, value="${element?.value || ''}", type="${element?.type || 'undefined'}"`);
    });
  }

  // Make debug functions globally available
  window.debugFormElements = debugFormElements;
  
  // Add a manual form inspector
  window.inspectForm = function() {
    console.log('üîç Manual Form Inspection:');
    console.log('Symbol input element:', document.getElementById('fSymbol'));
    console.log('Symbol input value:', document.getElementById('fSymbol')?.value);
    console.log('Symbol input innerHTML:', document.getElementById('fSymbol')?.outerHTML);
    console.log('All form inputs:');
    const form = document.getElementById('stockForm');
    const inputs = form?.querySelectorAll('input');
    inputs?.forEach((input, index) => {
      console.log(`  Input ${index}: id="${input.id}", value="${input.value}", placeholder="${input.placeholder}"`);
    });
  };

  // ===== Init =====
  (function init(){
    document.getElementById('year').textContent = new Date().getFullYear();
    // setTheme(state.theme);
    showSection('overview');
    renderAll();
    
    // Debug info on page load
    console.log('üöÄ Dashboard initialized');
    console.log('üë§ User ID from data attribute:', document.body.dataset.userid);
    
    // Add a delay to ensure DOM is fully loaded, then debug form elements
    setTimeout(() => {
      debugFormElements();
      
      // Add event listeners to track form field changes
      const symbolInput = el('#fSymbol');
      if (symbolInput) {
        symbolInput.addEventListener('input', (e) => {
          console.log('üìù Symbol field changed to: "' + e.target.value + '"');
        });
        symbolInput.addEventListener('blur', (e) => {
          console.log('üëÅÔ∏è Symbol field lost focus, value: "' + e.target.value + '"');
          const symbol = e.target.value.trim().toUpperCase();
          if (symbol && symbol.length >= 2) {
            fetchCurrentPrice(symbol);
          }
        });
      }
      
      // Track form reset events
      const form = el('#stockForm');
      if (form) {
        form.addEventListener('reset', () => {
          console.log('üîÑ Form was reset');
        });
      }
    }, 1000);
  })();
   // Safe helper name (replaces el)
  const qs = (selector) => document.querySelector(selector);

  // Find the search bar element
  const searchInput = qs('#stockSearchInput');
  if (searchInput) {
    // Create suggestion container
    const suggestionBox = document.createElement('div');
    suggestionBox.id = 'searchSuggestions';
    suggestionBox.className =
      'absolute bg-white border border-gray-200 rounded-lg shadow-md mt-2 w-full z-50 hidden';
    searchInput.parentNode.appendChild(suggestionBox);

    // Detect typing in search bar
    searchInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      if (query.length < 2) {
        suggestionBox.classList.add('hidden');
        return;
      }

      try {
        // Fetch matching stocks from backend
        const res = await fetch(`/api/search_company?company=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (!data.results || !data.results.length) {
          suggestionBox.innerHTML =
            `<div class="px-4 py-2 text-gray-500 text-sm">No matches found</div>`;
          suggestionBox.classList.remove('hidden');
          return;
        }

        // Build clickable list of suggestions with Save button
suggestionBox.innerHTML = data.results
  .map(
    (r) => `
      <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 text-sm border-b last:border-0">
        <div class="cursor-pointer flex-1" data-symbol="${r.symbol}">
          ${r.symbol} | ${r.shortname || ''} | ${r.exchange || ''}
        </div>
        <button 
          class="save-btn text-brand-blue text-xs font-medium border border-brand-blue rounded px-2 py-1 hover:bg-brand-blue hover:text-white transition"
          data-save-symbol="${r.symbol}">
          Save
        </button>
      </div>`
  )
  .join('');
        suggestionBox.classList.remove('hidden');
      } catch (error) {
        console.error('Error fetching stock list:', error);
      }
    });

    // Handle clicks on suggestions or Save buttons
suggestionBox.addEventListener('click', (e) => {
  const saveBtn = e.target.closest('[data-save-symbol]');
  const stockItem = e.target.closest('[data-symbol]');

  // If Save button clicked
  if (saveBtn) {
    const symbol = saveBtn.dataset.saveSymbol;
    suggestionBox.classList.add('hidden');

    // Switch to "My Stocks" section
    showSection('mystocks');

    // Open modal with symbol pre-filled
    openModal();
    el('#fSymbol').value = symbol;
    el('#lookupBtn').click();
    return;
  }

  // If stock name clicked
  if (stockItem) {
    const symbol = stockItem.dataset.symbol;
    searchInput.value = symbol;
    suggestionBox.classList.add('hidden');
    qs('#stockSearchBtn').click();
  }
});
  }

  // ===== Search Button Click Handler =====
  const searchBtn = qs('#stockSearchBtn');
  if (searchBtn) {
    searchBtn.addEventListener('click', () => {
      const query = qs('#stockSearchInput').value.trim().toUpperCase();
      if (!query) return;

      // Hide the action button and suggestion box on every new search
      qs('#search-actions').classList.add('hidden');
      const suggestionBox = qs('#searchSuggestions');
      if (suggestionBox) suggestionBox.classList.add('hidden');

      // Fetch the stock details from your backend API
      fetch(`/api/fetch_stock_details?symbol=${encodeURIComponent(query)}`)
        .then((res) => res.json())
        .then((data) => {
          const infoOther = qs('#info-other');
          const infoInvested = qs('#info-invested');
          const infoPredicted = qs('#info-predicted');

          if (data.error) {
            infoOther.textContent = 'Stock not found.';
            infoInvested.textContent = '‚Äî';
            infoPredicted.textContent = '‚Äî';
          } else {
            // Update the blocks 
            infoOther.textContent = `${data.longName || 'N/A'}`;
            infoInvested.textContent = fmt(data.currentPrice || 0); 
            infoPredicted.textContent = 'Calculating...'; 
            // add stock button 
            const prepareBtn = qs('#prepareAddStockBtn');
            prepareBtn.dataset.symbol = data.symbol; 
            qs('#search-actions').classList.remove('hidden'); 
          }
        })
        .catch((err) => {
            console.error('Error fetching details:', err);
            qs('#info-other').textContent = 'Error during search.';
        });
    });
  }

  // ===== Action Button to Open the Add Stock Modal =====
  const prepareBtn = qs('#prepareAddStockBtn');
  if (prepareBtn) {
    prepareBtn.addEventListener('click', function() {
      const symbol = this.dataset.symbol; // Get the symbol we stored earlier
      if (!symbol) return;

      //switching section to "My Stocks"
      showSection('mystocks');

      //Open the "Add Stock" modal 
      openModal();

      //Pre-fill the stock symbol 
      el('#fSymbol').value = symbol;

      //Automatically click the "Fetch Details" button 
      el('#lookupBtn').click();
    });
  }

  // ===== Auto-fetch Current Price =====
  async function fetchCurrentPrice(symbol) {
    const currentPriceInput = el('#fCurrent');
    if (!currentPriceInput) return;
    
    try {
      console.log('üîÑ Fetching current price for:', symbol);
      currentPriceInput.value = '';
      currentPriceInput.placeholder = 'Loading...';
      
      const response = await fetch('/api/stocks/get_stock_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol: symbol })
      });
      
      const data = await response.json();
      console.log('üìà Price data received:', data);
      
      if (response.ok && data.currentPrice) {
        currentPriceInput.value = parseFloat(data.currentPrice).toFixed(2);
        currentPriceInput.placeholder = parseFloat(data.currentPrice).toFixed(2);
        console.log('‚úÖ Set current price to:', data.currentPrice);
        
        // Also update company name if available
        if (data.longName && el('#fCompany')) {
          el('#fCompany').value = data.longName;
          console.log('‚úÖ Set company name to:', data.longName);
        }
        
        // Update currency field if available
        if (data.currency && el('#fCurrency')) {
          el('#fCurrency').value = data.currency;
          console.log('‚úÖ Set currency to:', data.currency);
        }
        
        // Show currency hint to user for buy price
        const buyPriceInput = el('#fBuy');
        if (buyPriceInput && data.currency) {
          const currencySymbol = data.currency === 'USD' ? '$' : data.currency === 'EUR' ? '‚Ç¨' : data.currency === 'GBP' ? '¬£' : '‚Çπ';
          buyPriceInput.placeholder = `Enter price in ${data.currency} (${currencySymbol})`;
          console.log('üí° Updated buy price placeholder for currency:', data.currency);
        }
      } else {
        currentPriceInput.value = '';
        currentPriceInput.placeholder = 'Price not found';
        console.log('‚ùå Failed to fetch price:', data.error || 'Unknown error');
      }
    } catch (error) {
      console.error('üí• Error fetching price:', error);
      currentPriceInput.value = '';
      currentPriceInput.placeholder = 'Error loading price';
    }
  }

  // ===== Delete Stock from Server =====
  async function deleteStockFromServer(symbol, localIndex) {
    try {
      const userId = document.body.dataset.userid || document.body.getAttribute('data-userid');
      
      if (!userId) {
        console.error('‚ùå No user_id found for delete operation');
        alert('Error: User not authenticated');
        return;
      }
      
      console.log('üóëÔ∏è Deleting stock from server:', symbol);
      
      const res = await fetch('/api/stocks/remove_stock', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          user_id: userId,
          symbol: symbol 
        })
      });
      
      const data = await res.json();
      console.log('üì• Delete response:', { status: res.status, data });
      
      if (res.ok) {
        console.log('‚úÖ Stock deleted from server:', symbol);
        
        // Update local state
        const s = state.stocks[localIndex];
        state.transactions.push({ 
          date: new Date().toISOString().slice(0,10), 
          symbol: s.symbol, 
          type: 'DELETE', 
          qty: s.qty, 
          price: s.buy, 
          total: s.buy * s.qty 
        });
        state.stocks.splice(localIndex, 1);
        
        renderAll();
        alert(`‚úÖ ${symbol} deleted successfully!`);
      } else {
        console.error('‚ùå Failed to delete from server:', data);
        alert(`‚ùå Error deleting ${symbol}: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('üí• Error deleting stock:', error);
      alert(`‚ùå Error deleting ${symbol}: ${error.message}`);
    }
  }

  // ===== Fetch Live Exchange Rates =====
  async function fetchExchangeRates() {
    try {
      console.log('üí± Fetching live exchange rates...');
      
      // Show loading state
      document.getElementById('rate-timestamp').textContent = 'Updating...';
      
      // Fetch from backend API which will handle the external API call
      const response = await fetch('/api/exchange-rates');
      const data = await response.json();
      
      if (response.ok && data.rates) {
        console.log('‚úÖ Exchange rates received:', data.rates);
        
        // Calculate rates from USD to INR, EUR, GBP
        const usdToInr = data.rates.INR || 84;
        const usdToEur = data.rates.EUR || 0.92;
        const usdToGbp = data.rates.GBP || 0.78;
        
        // Display USD to INR (1 USD = X INR)
        document.getElementById('rate-usd').textContent = `‚Çπ${usdToInr.toFixed(2)}`;
        
        // Display EUR to INR (1 EUR = X INR)
        const eurToInr = usdToInr / usdToEur;
        document.getElementById('rate-eur').textContent = `‚Çπ${eurToInr.toFixed(2)}`;
        
        // Display GBP to INR (1 GBP = X INR)
        const gbpToInr = usdToInr / usdToGbp;
        document.getElementById('rate-gbp').textContent = `‚Çπ${gbpToInr.toFixed(2)}`;
        
        // Update timestamp and status indicator
        const now = new Date().toLocaleString();
        document.getElementById('rate-timestamp').textContent = now;
        document.getElementById('rate-status-indicator').className = 'inline-block w-2 h-2 bg-green-400 rounded-full ml-2';
        document.getElementById('rate-status-indicator').title = 'Live rates from ExchangeRate-API';
        
        // Update the global FX rates used throughout the application
        FX = {
          USD: 1,
          EUR: usdToEur,
          GBP: usdToGbp,
          INR: usdToInr
        };
        
        console.log('‚úÖ Updated global FX rates for all conversions:', FX);
        
        // Refresh all UI components that use currency conversion
        refreshAllCurrencyDisplays();
        
      } else {
        console.log('‚ö†Ô∏è Failed to fetch live rates, using default values');
        document.getElementById('rate-timestamp').textContent = 'Failed to update';
        
        // Still update display with default rates
        document.getElementById('rate-usd').textContent = `‚Çπ${FX.INR.toFixed(2)}`;
        document.getElementById('rate-eur').textContent = `‚Çπ${(FX.INR / FX.EUR).toFixed(2)}`;
        document.getElementById('rate-gbp').textContent = `‚Çπ${(FX.INR / FX.GBP).toFixed(2)}`;
        document.getElementById('rate-status-indicator').className = 'inline-block w-2 h-2 bg-red-400 rounded-full ml-2';
        document.getElementById('rate-status-indicator').title = 'Using default rates (API failed)';
      }
    } catch (error) {
      console.error('üí• Error fetching exchange rates:', error);
      document.getElementById('rate-timestamp').textContent = 'Error loading';
      
      // Still update display with default rates on error
      document.getElementById('rate-usd').textContent = `‚Çπ${FX.INR.toFixed(2)}`;
      document.getElementById('rate-eur').textContent = `‚Çπ${(FX.INR / FX.EUR).toFixed(2)}`;
      document.getElementById('rate-gbp').textContent = `‚Çπ${(FX.INR / FX.GBP).toFixed(2)}`;
      document.getElementById('rate-status-indicator').className = 'inline-block w-2 h-2 bg-red-400 rounded-full ml-2';
      document.getElementById('rate-status-indicator').title = 'Using default rates (Connection error)';
    }
  }

  // ===== Fetch and Display My Stocks =====
async function loadMyStocks() {
  // Get user_id from multiple sources
  const userId = document.body.dataset.userid || document.body.getAttribute('data-userid');
  
  console.log('üîç loadMyStocks - userId:', userId);
  
  if (!userId) {
    console.warn('‚ö†Ô∏è No user_id found, cannot load stocks');
    return;
  }

  try {
    const res = await fetch(`/api/stocks/get_stocks?user_id=${userId}`);
    const data = await res.json();

    // Normalize server stocks into the client state shape
    if (data.stocks && Array.isArray(data.stocks)) {
      state.stocks = data.stocks.map(s => ({
        symbol: s.symbol,
        company: s.name || s.longName || s.company || '',
        qty: s.qty || 0,
        buy: s.buy_price || s.buy || null,
        current: s.current_price || s.currentPrice || s.current || null,
        date: s.date || s.created_at || '',
        currency: s.currency || 'USD'
      }));
      // Update UI (table, KPIs)
      renderAll();
    }

    // Also populate compact saved-stocks list if present
    const container = document.getElementById("myStocksList");
    if (container) {
      if (!data.stocks || data.stocks.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-sm">No saved stocks yet.</p>`;
      } else {
        container.innerHTML = data.stocks
          .map(
            (s) => `
            <div class="p-3 border border-gray-200 rounded-lg shadow-sm bg-white flex justify-between items-center">
              <div>
                <p class="font-semibold">${s.symbol}</p>
                <p class="text-sm text-gray-600">${s.name || s.longName || ''} (${s.exchange || ''})</p>
              </div>
              <button class="text-red-500 text-sm" onclick="removeStock('${s.symbol}')">Remove</button>
            </div>`
          )
          .join("");
      }
    }
  } catch (error) {
    console.error("Error loading stocks:", error);
  }
}

// Load saved stocks when page opens
document.addEventListener("DOMContentLoaded", () => {
  loadMyStocks();
  fetchExchangeRates();
  
  // Refresh exchange rates every 30 minutes
  setInterval(fetchExchangeRates, 30 * 60 * 1000);
});

  // ===== Save Stock to MongoDB =====
const saveBtn = document.getElementById("saveStockBtn");
if (saveBtn) {
  saveBtn.addEventListener("click", async () => {
    const symbol = document.getElementById("stockSearchInput").value.trim();
    const infoText = document.getElementById("info-other")?.textContent || "";

    if (!symbol) {
      alert("Please search and select a stock first!");
      return;
    }

    // Extract stock info
    const [longName, exchangeRaw] = infoText.split("(");
    const exchange = exchangeRaw ? exchangeRaw.replace(")", "").trim() : "‚Äî";
    const userId = document.body.dataset.userid || document.body.getAttribute('data-userid');

    if (!userId) {
      alert("Error: User session not found. Please refresh the page and try again.");
      return;
    }

    const stockData = {
      user_id: userId,
      symbol: symbol,
      longName: longName?.trim() || symbol,
      exchange: exchange,
    };

    try {
      const res = await fetch("/api/stocks/add_stock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(stockData),
      });

      const data = await res.json();
      if (data.message) {
        alert("‚úÖ Stock saved successfully!");
        loadMyStocks(); // refresh stocks display
      } else {
        alert("‚ö†Ô∏è " + (data.error || "Something went wrong."));
      }
    } catch (error) {
      console.error("Error saving stock:", error);
      alert("‚ö†Ô∏è Could not connect to server.");
    }
  });
}
// ===== Remove a Stock =====
async function removeStock(symbol) {
  if (!confirm(`Are you sure you want to remove ${symbol}?`)) {
    return;
  }

  const userId = document.body.dataset.userid || document.body.getAttribute('data-userid');
  if (!userId) {
    alert("Could not identify user. Please refresh the page and try again.");
    return;
  }

  try {
    const res = await fetch("/api/stocks/remove_stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, symbol: symbol }),
    });

    const data = await res.json();
    if (res.ok) {
      alert(" Stock removed successfully!");
      loadMyStocks(); // Refresh the list from the backend
    } else {
      alert(" !! " + (data.error || "Something went wrong."));
    }
  } catch (error) {
    console.error("Error removing stock:", error);
    alert("Could not connect to the server.");
  }
}
</script>
</body>
</html>
